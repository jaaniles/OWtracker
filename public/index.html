<!DOCTYPE html>
<html lang="en">
<head>
    <script src="/socket.io/socket.io.js"></script>
    <link href="/css/OWtracker.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/3.6.4/firebase.js"></script>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
    <script src="https://cdn.firebase.com/libs/firebaseui/1.0.0/firebaseui.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/1.0.0/firebaseui.css" />
    <script>
    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyCmBhbJCioIU0_9AWsrvyhEcZBHgH6S1gI",
        authDomain: "scoretracker-9a7e5.firebaseapp.com",
        databaseURL: "https://scoretracker-9a7e5.firebaseio.com",
        storageBucket: "scoretracker-9a7e5.appspot.com",
        messagingSenderId: "783389239694"
    };
    firebase.initializeApp(config);
    var database = firebase.database()

    // FirebaseUI config.
    var uiConfig = {
        signInSuccessUrl: '/success',
        signInOptions: [
            firebase.auth.GoogleAuthProvider.PROVIDER_ID,
            firebase.auth.EmailAuthProvider.PROVIDER_ID
        ],
        tosUrl: '/tos'
    };
    var ui = new firebaseui.auth.AuthUI(firebase.auth());
    ui.start('#firebaseui-auth-container', uiConfig);

    initApp = function() {
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            document.getElementById("signed_in_view").className = "box"
            document.getElementById("firebaseui-auth-container").className = "hide"
            // User is signed in.
            var displayName = user.displayName;
            document.getElementById("displayName").innerHTML = displayName
            var email = user.email;
            var emailVerified = user.emailVerified;
            var photoURL = user.photoURL;
            var uid = user.uid;
            var providerData = user.providerData;
            user.getToken().then(function(accessToken) {
                socket.emit("sign_in", {user: accessToken})
            });
          } else {
                document.getElementById("signed_in_view").className = "box hide"
                document.getElementById("firebaseui-auth-container").className = ""
          }
        }, function(error) {
          console.log(error);
        });
      };

      window.addEventListener('load', function() {
        initApp()
      });
    </script>
    <meta charset="UTF-8">
    <title>OW Rating Tracker</title>
</head>
<body>
    <div id="firebaseui-auth-container"></div>
    <div id="signed_in_view" class="hide">
        <h1>Hello, <span id='displayName'></span></h1>
        <div class="box">
            <input id='battlenet' type="text" placeholder="BattleTag">
            <button onclick="addPlayer()">Track player</button>
            <br>
            <i><small>
                Upper/lowercase matter. (ex. player#6666)
            </small></i>
        </div>
        <div id="players">
            <i id='playerLoader' class="fa fa-spinner fa-spin fa-3x fa-fw"></i>    
        </div> 
        <button onclick='signOut()'>Log out</button>       
    </div>
</body>
</html>
<script>
    var playerlist = [];
    function addPlayer(){
        var battleNet = document.getElementById("battlenet").value
        battleNet = battleNet.replace("#", "-")
        var user = firebase.auth().currentUser;
        if (user) {
            user.getToken().then(function(accessToken) {
                socket.emit("add_player", {battleNet: battleNet, tkn: accessToken})
            })
        } 
    }
    function drawCharts(){
        playerlist.forEach(function(player){
            var labels = []
            var series = []
            Object.keys(player.ranks).forEach(function(rank) {
                labels.push(timeConverter(player.ranks[rank].timestamp))
                series.push(player.ranks[rank].rank)
            })

            // Chart stuff
            var data = {
                labels: labels,
                series: [series]
            };
            var playerChart = player.playerName+"_chart"
            new Chartist.Line("#"+playerChart, data)
        })
    }
    /*
    var socket = io.connect(window.location.origin)
    socket.on("playerdata", function(data){
        document.getElementById('playerLoader').className = "hide"
        
        var player = data.player
        var playerName = player.playerName
        var newestRank = player.ranks[Object.keys(player.ranks)[Object.keys(player.ranks).length-1]]
        playerlist.push({playerName: playerName, ranks: player.ranks})
        var playerBox = "<div class='box'><h4>"+playerName+"</h4>"
        +"<p id='"+playerName+"_rank'><img src='"+newestRank.rank_img+"' class='rankImg'>"
            +newestRank.rank
        +"</p>"
        +"<img id='"+playerName+"_avatar' class='avatar' src='"+player.avatar+"'>"
        +"<div id='"+playerName+"_chart' class='ct-chart ct-perfect-fourth'></div>"
        +"</div>"
        document.getElementById("players").innerHTML += playerBox        

        drawCharts()
    })

    socket.on("broadcastPlayers", function(data){
        var playersList = []
        document.getElementById("players").innerHTML = ""

        var players = data.players
        Object.keys(players).forEach(function(player) {
            var player = players[player]
            var newestRank = player.ranks[Object.keys(player.ranks)[Object.keys(player.ranks).length-1]]

            var playerName = player.playerName.split('-')[0]
            playersList.push(player)
            var playerChart = playerName + "_chart"
            var playerBox = "<div class='box'><h4>"+playerName+"</h4>"
            +"<p id='"+playerName+"_rank'><img src='"+player.rankImg+"' class='rankImg'>"
                +newestRank.rank
            +"</p>"
            +"<img id='"+playerName+"_avatar' class='avatar' src='"+player.avatar+"'>"
            +"<div id='"+playerChart+"' class='ct-chart ct-perfect-fourth'></div>"
            +"</div>"
            document.getElementById("players").innerHTML += playerBox
        });
        playersList.forEach(function(player){
            var labels = []
            var series = []
            
            Object.keys(player.ranks).forEach(function(rank) {
                labels.push(timeConverter(player.ranks[rank].timestamp))
                series.push(player.ranks[rank].rank)
            })

            // Chart stuff
            var data = {
                labels: labels,
                series: [series]
            };
            var playerChart = player.playerName.split('-')[0]+"_chart"
            console.log(playerChart)
            new Chartist.Line("#"+playerChart, data)

        })
    })
    socket.on("broadcastPlayer", function(data){
        return;
        var player = data.player
        var playerName = player.playerName.split('-')[0]
        var rankImg = "<img src='"+player.rankImg+"' class='rankImg'>"
        var newestRank = player.ranks[Object.keys(player.ranks)[Object.keys(player.ranks).length-1]]

        document.getElementById(playerName+"_avatar").src = player.avatar
        document.getElementById(playerName+"_rank").innerHTML = rankImg + newestRank.rank

    })
    
    /*
    addRating("naamaan-2149", "https://blzgdapipro-a.akamaihd.net/game/unlocks/0x0250000000000776.png")
    addRating("Multix-2831", "https://blzgdapipro-a.akamaihd.net/game/unlocks/0x0250000000000776.png")
    addRating("Masennus-2495", "https://blzgdapipro-a.akamaihd.net/game/unlocks/0x0250000000000776.png")
    addRating("Eenokki-2380", "https://blzgdapipro-a.akamaihd.net/game/unlocks/0x0250000000000776.png")
    addRating("Goljatti-2382", "https://blzgdapipro-a.akamaihd.net/game/unlocks/0x0250000000000776.png")
    addRating("veldt-21233", "https://blzgdapipro-a.akamaihd.net/game/unlocks/0x0250000000000776.png")
    */

    function addRating(player, avatar){
        database.ref("players/" + player).set({
            avatar: avatar,
            playerName: player,
            ranks: {
                0: {
                    rank: 0,
                    timestamp: 0
                }
            }
        })
    }

    function timeConverter(UNIX_timestamp){
        var a = new Date(UNIX_timestamp * 1000);
        var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        var year = a.getFullYear();
        var month = months[a.getMonth()];
        var date = a.getDate();
        var hour = a.getHours();
        var min = a.getMinutes();
        var sec = a.getSeconds();
        var time = date + ' ' + month + ' ' + year + ' ' + hour + ':' + min + ':' + sec ;
        return time;
    }
    function signOut(){
        firebase.auth().signOut().then(function() {
            console.log('Signed Out');
        })
    }
</script>
